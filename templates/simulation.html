{% extends "base.html" %}

{% block title %}Simulation | Meteor Madness - Asteroid Defense Command{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/simulation.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/tooltips.css') }}">
<link href="https://cesium.com/downloads/cesiumjs/releases/1.87/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
<script src="https://cesium.com/downloads/cesiumjs/releases/1.87/Build/Cesium/Cesium.js"></script>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <section class="info-panel thought-panel">
        <i class="fas fa-brain thought-icon"></i>
        <div class="thought-content">
            <p class="thought-quote">"Trajectory is the language of fate. Precision in modeling ensures foresight in defense."</p>
            <span class="thought-source">- Sentinel AI Command Log</span>
        </div>
    </section>

    <section class="simulation-master-grid">
        <div class="control-panel module-card">
            <h2 class="module-title"><i class="fas fa-sliders-h"></i> Scenario Parameters</h2>
            
            <div class="control-section selection-group">
                <label for="neo-select" class="control-label">Select/Identify Threat Object</label>
                <select id="neo-select" class="control-input-select" aria-label="Select Near Earth Object">
                    <option value="custom">-- Loading NEO Data --</option>
                </select>
                <p class="input-tip">Real-time data from NASA NeoWs is loaded here.</p>
            </div>

            <div class="control-section slider-group">
                <label class="control-label">Asteroid Diameter: <span id="size-value" class="value-display">500 m</span></label>
                <input type="range" id="asteroid-size" min="10" max="5000" value="500" class="slider-input" aria-valuemin="10" aria-valuemax="5000" aria-label="Asteroid Diameter">
                <p class="input-tip" data-tooltip-id="tooltip-diameter">Influence: Crater size and blast energy.</p>
            </div>

            <div class="control-section slider-group">
                <label class="control-label">Impact Velocity: <span id="speed-value" class="value-display">17 km/s</span></label>
                <input type="range" id="asteroid-speed" min="5" max="72" value="17" class="slider-input" aria-valuemin="5" aria-valuemax="72" aria-label="Impact Velocity">
                <p class="input-tip" data-tooltip-id="tooltip-velocity">Influence: Kinetic energy and atmospheric entry effects.</p>
            </div>

            <div class="control-section slider-group">
                <label class="control-label">Impact Angle: <span id="angle-value" class="value-display">45°</span></label>
                <input type="range" id="impact-angle" min="0" max="90" value="45" class="slider-input" aria-valuemin="0" aria-valuemax="90" aria-label="Impact Angle">
                <p class="input-tip">Influence: Ejecta pattern and effective energy transfer.</p>
            </div>

            <div class="control-section selection-group">
                <label for="location" class="control-label">Target Environment</label>
                <select id="location" class="control-input-select" aria-label="Select Target Environment">
                    <option value="ocean" class="option-ocean">Deep Ocean</option>
                    <option value="land" selected class="option-land">Continental Landmass</option>
                    <option value="coastal" class="option-coastal">Coastal Region</option>
                </select>
                <p class="input-tip">Determines seismic and tsunami modeling.</p>
            </div>

            <div class="control-section location-input-group">
                <label class="control-label">Impact Coordinates (Click 3D Globe)</label>
                <input type="text" id="impact-lat" class="control-input-text" placeholder="Latitude (0.0)" value="34.0522" aria-label="Impact Latitude">
                <input type="text" id="impact-lng" class="control-input-text" placeholder="Longitude (0.0)" value="-118.2437" aria-label="Impact Longitude">
                <p class="input-tip">Coordinates are sent to the Impact Analysis map.</p>
            </div>
            
            <h3 class="module-title-secondary"><i class="fas fa-chart-bar"></i> Orbital Elements (Optional)</h3>
            <div class="control-section orbital-elements-group">
                <label class="control-label" data-tooltip-id="tooltip-semimajor">Semi-major axis a (km):</label>
                <input type="number" id="orb-a" class="control-input-text" placeholder="e.g., 149597870" aria-label="Semi-major axis in kilometers">
                
                <label class="control-label" data-tooltip-id="tooltip-eccentricity">Eccentricity e:</label>
                <input type="number" id="orb-e" class="control-input-text" placeholder="e.g., 0.0167" step="any" min="0" max="1" aria-label="Orbital eccentricity">
                
                <label class="control-label" data-tooltip-id="tooltip-inclination">Inclination i (deg):</label>
                <input type="number" id="orb-i" class="control-input-text" placeholder="e.g., 23.4" step="any" min="0" max="180" aria-label="Orbital inclination in degrees">
                
                <label class="control-label" data-tooltip-id="tooltip-longAsc">Long. Ascending Node Ω (deg):</label>
                <input type="number" id="orb-omega-asc" class="control-input-text" placeholder="e.g., 125.6" step="any" min="0" max="360" aria-label="Longitude of ascending node in degrees">

                <label class="control-label" data-tooltip-id="tooltip-argPeri">Arg. of Periapsis ω (deg):</label>
                <input type="number" id="orb-omega-peri" class="control-input-text" placeholder="e.g., 286.1" step="any" min="0" max="360" aria-label="Argument of periapsis in degrees">

                <label class="control-label" data-tooltip-id="tooltip-trueAnomaly">True Anomaly ν (deg):</label>
                <input type="number" id="orb-nu" class="control-input-text" placeholder="e.g., 174.9" step="any" min="0" max="360" aria-label="True anomaly in degrees">
                <p class="input-tip">Filling these fields will override the manual velocity slider.</p>
            </div>

            <div class="action-buttons-group">
                <button id="run-simulation" class="btn btn-primary btn-full-width btn-cta" aria-label="Run Simulation and Analyze"><i class="fas fa-play-circle"></i> Run Simulation & Analyze</button>
                <button class="btn btn-secondary btn-full-width" aria-label="Save Scenario Preset"><i class="fas fa-save"></i> Save Scenario Preset</button>
            </div>
        </div>

        <div class="visualization-panel module-card">
            <div class="visualization-header">
                <h2 class="module-title"><i class="fas fa-globe-americas"></i> Orbital Projection (3D)</h2>
                <div class="control-buttons">
                    <button class="btn btn-tertiary" id="reset-view-btn" aria-label="Reset View"><i class="fas fa-camera"></i> Reset View</button>
                    <button class="btn btn-tertiary" id="measure-btn" aria-label="Measure Distance"><i class="fas fa-ruler"></i> Measure Distance</button>
                </div>
            </div>
            <div id="cesium-container" class="visualization-container" tabindex="0" aria-label="3D globe visualization. Click to set impact location.">
            </div>
            <div class="visualization-footer">
                 <p class="small-text">Visualization provided by CesiumJS (Web-GL engine). Click on the globe to set the impact location.</p>
                 <div class="location-details-display">
                    <span class="detail-label">Current Location:</span>
                    <span id="current-location-city-country" class="detail-value">N/A</span><br>
                    <span class="detail-label">Full Address:</span>
                    <span id="current-location-address" class="detail-value">N/A</span>
                 </div>
            </div>
        </div>
    </section>
    
    <section class="feature-expansion-grid">
        <div class="expansion-card module-card">
            <h3 class="module-title"><i class="fas fa-microchip"></i> AI Predictive Corridor</h3>
            <p class="module-description">Toggle probabilistic risk corridors based on orbital uncertainty data. (Feature Expansion)</p>
            <button class="btn btn-tertiary"><i class="fas fa-toggle-on"></i> Enable AI Risk Modeling</button>
        </div>
        <div class="expansion-card module-card">
            <h3 class="module-title"><i class="fas fa-wave-square"></i> Sonification Preview</h3>
            <p class="module-description">Translate seismic/blast data into audible frequency patterns. (Feature Expansion)</p>
            <button class="btn btn-tertiary"><i class="fas fa-volume-up"></i> Calibrate Audio Feed</button>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/simulation.js') }}"></script>
<audio id="impact-sound" src="{{ url_for('static', filename='sounds/explosion.mp3') }}" preload="auto"></audio>
<div id="explosion-overlay"></div>
{% endblock %}